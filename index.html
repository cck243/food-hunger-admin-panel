<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hunger Food Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #FF5722;
            --secondary-color: #FF8A65;
            --dark-color: #333;
            --light-color: #f8f9fa;
            --white-color: #fff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            background: var(--light-color);
            display: flex;
            min-height: 100vh;
        }

        /* Utility Classes */
        .container {
            max-width: 1200px;
            margin: auto;
            overflow: hidden;
            padding: 0 20px;
        }

        .btn {
            display: inline-block;
            background: var(--primary-color);
            color: var(--white-color);
            padding: 8px 15px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            border-radius: 5px;
            transition: background 0.3s ease;
            text-decoration: none;
            text-align: center;
        }

        .btn:hover {
            background: var(--secondary-color);
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .btn-success { background: var(--success-color); }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: var(--danger-color); }
        .btn-danger:hover { background: #c82333; }
        .btn-warning { background: var(--warning-color); color: var(--dark-color);}
        .btn-warning:hover { background: #e0a800; }
        .btn-info { background: var(--info-color); }
        .btn-info:hover { background: #138496; }

        .card {
            background: var(--white-color);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .card-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--dark-color);
        }

        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="text"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--white-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        table th, table td {
            padding: 12px 15px;
            border: 1px solid #eee;
            text-align: left;
            vertical-align: middle;
        }

        table thead th {
            background: var(--primary-color);
            color: var(--white-color);
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        table tbody tr:nth-child(even) {
            background: #f9f9f9;
        }

        table tbody tr:hover {
            background: #f1f1f1;
        }

        /* Layout */
        .sidebar {
            width: 250px;
            background: var(--dark-color);
            color: var(--white-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 1.8rem;
        }

        .sidebar ul {
            list-style: none;
            flex-grow: 1;
        }

        .sidebar ul li {
            margin-bottom: 15px;
        }

        .sidebar ul li a {
            color: var(--white-color);
            text-decoration: none;
            display: block;
            padding: 10px 15px;
            border-radius: 5px;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
        }
        .sidebar ul li a i {
            margin-right: 10px;
            font-size: 1.1rem;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background: var(--primary-color);
        }

        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: var(--white-color);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 25px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-left: 5px solid var(--primary-color);
        }
        .dashboard-card h3 {
            font-size: 1.1rem;
            color: #555;
            margin-bottom: 10px;
        }
        .dashboard-card p {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: bold;
            color: var(--white-color);
        }
        .status-approved { background-color: var(--success-color); }
        .status-pending { background-color: var(--warning-color); color: var(--dark-color); }
        .status-rejected { background-color: var(--danger-color); }
        .status-placed { background-color: var(--info-color); }
        .status-accepted { background-color: #6c757d; }
        .status-preparing { background-color: #007bff; } /* Blue */
        .status-ready_for_pickup { background-color: #fd7e14; } /* Orange */
        .status-picked_up { background-color: #20c997; } /* Teal */
        .status-out_for_delivery { background-color: #6f42c1; } /* Purple */
        .status-delivered { background-color: var(--success-color); }
        .status-cancelled { background-color: var(--danger-color); }


        .page-content {
            display: none; /* Hidden by default */
        }
        .page-content.active {
            display: block;
        }

        /* Login Page Styling */
        #login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        }
        #login-form-card {
            width: 100%;
            max-width: 400px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        #login-form-card h2 {
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 2rem;
        }
        #login-form-card .btn {
            width: 100%;
            padding: 12px;
            font-size: 1.1rem;
            margin-top: 20px;
        }
        .error-message {
            color: var(--danger-color);
            margin-top: 15px;
            font-weight: bold;
        }

        #add-notification-form textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                padding: 15px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
            .sidebar h2 {
                margin-bottom: 20px;
            }
            .sidebar ul {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
            .sidebar ul li {
                margin-bottom: 0;
            }
            .sidebar ul li a {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            .sidebar ul li a i {
                margin-right: 5px;
            }
            .main-content {
                padding: 20px;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            table th, table td {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
            .btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // <<< REPLACE THIS
            authDomain: "YOUR_AUTH_DOMAIN", // <<< REPLACE THIS
            projectId: "YOUR_PROJECT_ID", // <<< REPLACE THIS
            storageBucket: "YOUR_STORAGE_BUCKET", // <<< REPLACE THIS
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID", // <<< REPLACE THIS
            appId: "YOUR_APP_ID", // <<< REPLACE THIS
            databaseURL: "YOUR_DATABASE_URL" // <<< REPLACE THIS
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentAdminUid = null;

        document.addEventListener('DOMContentLoaded', () => {
            setupAuthUI();
            setupSidebarNavigation();
            addEventListeners();
        });

        auth.onAuthStateChanged(user => {
            if (user) {
                // Admin login succeeds, no DB check needed as per requirements
                currentAdminUid = user.uid;
                document.body.classList.remove('logged-out');
                document.body.classList.add('logged-in');
                showPage('dashboard');
                loadDashboardStats();
                loadPendingRestaurants();
                loadPendingDeliveryPartners();
                loadCustomers();
                loadOrders();
                loadNotifications();
            } else {
                currentAdminUid = null;
                document.body.classList.remove('logged-in');
                document.body.classList.add('logged-out');
                showPage('login-page');
            }
        });

        function showPage(pageId) {
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            document.querySelectorAll('.sidebar-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const navItem = document.querySelector(`.sidebar-nav-item[data-page="${pageId}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }
        }

        function setupAuthUI() {
            const loginForm = document.getElementById('admin-login-form');
            const loginErrorMessage = document.getElementById('login-error-message');

            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    loginErrorMessage.textContent = '';
                    const email = loginForm['login-email'].value;
                    const password = loginForm['login-password'].value;

                    try {
                        await auth.signInWithEmailAndPassword(email, password);
                        // onAuthStateChanged will handle redirection to dashboard
                    } catch (error) {
                        loginErrorMessage.textContent = `Login failed: ${error.message}`;
                    }
                });
            }
        }

        function setupSidebarNavigation() {
            document.getElementById('nav-dashboard').addEventListener('click', (e) => { e.preventDefault(); showPage('dashboard'); loadDashboardStats(); });
            document.getElementById('nav-restaurants').addEventListener('click', (e) => { e.preventDefault(); showPage('restaurants-page'); loadPendingRestaurants(); });
            document.getElementById('nav-delivery-boys').addEventListener('click', (e) => { e.preventDefault(); showPage('delivery-boys-page'); loadPendingDeliveryPartners(); });
            document.getElementById('nav-customers').addEventListener('click', (e) => { e.preventDefault(); showPage('customers-page'); loadCustomers(); });
            document.getElementById('nav-orders').addEventListener('click', (e) => { e.preventDefault(); showPage('orders-page'); loadOrders(); });
            document.getElementById('nav-notifications').addEventListener('click', (e) => { e.preventDefault(); showPage('notifications-page'); loadNotifications(); });
            document.getElementById('nav-reports').addEventListener('click', (e) => { e.preventDefault(); showPage('reports-page'); loadReports(); });
            document.getElementById('logout-btn').addEventListener('click', logout);
        }

        function addEventListeners() {
            document.getElementById('send-notification-btn').addEventListener('click', sendNotification);
        }

        async function logout() {
            try {
                await auth.signOut();
                // onAuthStateChanged will handle redirection to login page
                // Clear any local state if necessary
            } catch (error) {
                console.error("Error logging out:", error);
                alert("Failed to log out. Please try again.");
            }
        }

        // --- Dashboard Functions ---
        async function loadDashboardStats() {
            try {
                const [
                    customersSnap,
                    restaurantsSnap,
                    deliveryPartnersSnap,
                    ordersSnap
                ] = await Promise.all([
                    database.ref('customers').once('value'),
                    database.ref('restaurants').once('value'),
                    database.ref('deliveryPartners').once('value'),
                    database.ref('orders').once('value')
                ]);

                const customers = customersSnap.val();
                const restaurants = restaurantsSnap.val();
                const deliveryPartners = deliveryPartnersSnap.val();
                const orders = ordersSnap.val();

                let totalCustomers = customers ? Object.keys(customers).length : 0;
                let totalRestaurants = 0;
                let pendingRestaurants = 0;
                if (restaurants) {
                    Object.values(restaurants).forEach(r => {
                        if (r.approved) totalRestaurants++;
                        else pendingRestaurants++;
                    });
                }

                let totalDeliveryBoys = 0;
                let pendingDeliveryBoys = 0;
                if (deliveryPartners) {
                    Object.values(deliveryPartners).forEach(dp => {
                        if (dp.approved) totalDeliveryBoys++;
                        else pendingDeliveryBoys++;
                    });
                }

                let totalOrders = orders ? Object.keys(orders).length : 0;
                let codRevenue = 0;
                if (orders) {
                    Object.values(orders).forEach(order => {
                        if (order.status === 'DELIVERED') { // Assuming COD revenue is calculated only for delivered orders
                            codRevenue += order.totalAmount || 0;
                        }
                    });
                }

                document.getElementById('stat-customers').textContent = totalCustomers;
                document.getElementById('stat-restaurants').textContent = totalRestaurants;
                document.getElementById('stat-pending-restaurants').textContent = pendingRestaurants;
                document.getElementById('stat-delivery-boys').textContent = totalDeliveryBoys;
                document.getElementById('stat-pending-delivery-boys').textContent = pendingDeliveryBoys;
                document.getElementById('stat-orders').textContent = totalOrders;
                document.getElementById('stat-cod-revenue').textContent = `$${codRevenue.toFixed(2)}`;

            } catch (error) {
                console.error("Error loading dashboard stats:", error);
                alert("Failed to load dashboard statistics.");
            }
        }

        // --- Restaurants Management ---
        async function loadPendingRestaurants() {
            const pendingRestaurantsTableBody = document.getElementById('pending-restaurants-table-body');
            pendingRestaurantsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Loading pending restaurants...</td></tr>';
            const approvedRestaurantsTableBody = document.getElementById('approved-restaurants-table-body');
            approvedRestaurantsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Loading approved restaurants...</td></tr>';

            try {
                const snapshot = await database.ref('restaurants').once('value');
                const restaurants = snapshot.val();

                pendingRestaurantsTableBody.innerHTML = '';
                approvedRestaurantsTableBody.innerHTML = '';

                if (restaurants) {
                    let hasPending = false;
                    let hasApproved = false;

                    Object.keys(restaurants).forEach(id => {
                        const r = restaurants[id];
                        const row = `
                            <tr>
                                <td>${r.name}</td>
                                <td>${r.email}</td>
                                <td>${r.cuisine || 'N/A'}</td>
                                <td>${r.address}</td>
                                <td><span class="status-badge status-${r.approved ? 'approved' : 'pending'}">${r.approved ? 'Approved' : 'Pending'}</span></td>
                                <td>
                                    ${!r.approved ? `<button class="btn btn-success btn-sm" onclick="approveRestaurant('${id}')">Approve</button>` : ''}
                                    ${r.approved ? `<button class="btn btn-warning btn-sm" onclick="rejectRestaurant('${id}')">Reject</button>` : ''}
                                    <button class="btn btn-danger btn-sm" onclick="deleteRestaurant('${id}')">Delete</button>
                                </td>
                            </tr>
                        `;
                        if (!r.approved) {
                            pendingRestaurantsTableBody.innerHTML += row;
                            hasPending = true;
                        } else {
                            approvedRestaurantsTableBody.innerHTML += row;
                            hasApproved = true;
                        }
                    });

                    if (!hasPending) {
                        pendingRestaurantsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No pending restaurants.</td></tr>';
                    }
                    if (!hasApproved) {
                        approvedRestaurantsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No approved restaurants.</td></tr>';
                    }
                } else {
                    pendingRestaurantsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No restaurants found.</td></tr>';
                    approvedRestaurantsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No restaurants found.</td></tr>';
                }
            } catch (error) {
                console.error("Error loading restaurants:", error);
                pendingRestaurantsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--danger-color);">Failed to load restaurants.</td></tr>';
                approvedRestaurantsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--danger-color);">Failed to load restaurants.</td></tr>';
            }
        }

        async function approveRestaurant(restaurantId) {
            if (confirm("Are you sure you want to APPROVE this restaurant?")) {
                try {
                    await database.ref(`restaurants/${restaurantId}`).update({ approved: true });
                    alert("Restaurant approved successfully!");
                    loadPendingRestaurants(); // Reload the list
                    loadDashboardStats(); // Update stats
                } catch (error) {
                    console.error("Error approving restaurant:", error);
                    alert("Failed to approve restaurant.");
                }
            }
        }

        async function rejectRestaurant(restaurantId) {
             if (confirm("Are you sure you want to REJECT this restaurant? This will mark it as pending again.")) {
                try {
                    await database.ref(`restaurants/${restaurantId}`).update({ approved: false });
                    alert("Restaurant rejected (marked as pending) successfully!");
                    loadPendingRestaurants(); // Reload the list
                    loadDashboardStats(); // Update stats
                } catch (error) {
                    console.error("Error rejecting restaurant:", error);
                    alert("Failed to reject restaurant.");
                }
            }
        }

        async function deleteRestaurant(restaurantId) {
            if (confirm("Are you sure you want to DELETE this restaurant? This action is irreversible.")) {
                try {
                    await database.ref(`restaurants/${restaurantId}`).remove();
                    // Also consider deleting associated menus and potentially orders
                    await database.ref(`menus/${restaurantId}`).remove();
                    alert("Restaurant and its menu deleted successfully!");
                    loadPendingRestaurants(); // Reload the list
                    loadDashboardStats(); // Update stats
                } catch (error) {
                    console.error("Error deleting restaurant:", error);
                    alert("Failed to delete restaurant.");
                }
            }
        }

        // --- Delivery Boys Management ---
        async function loadPendingDeliveryPartners() {
            const pendingDeliveryBoysTableBody = document.getElementById('pending-delivery-boys-table-body');
            pendingDeliveryBoysTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Loading pending delivery partners...</td></tr>';
            const approvedDeliveryBoysTableBody = document.getElementById('approved-delivery-boys-table-body');
            approvedDeliveryBoysTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Loading approved delivery partners...</td></tr>';

            try {
                const snapshot = await database.ref('deliveryPartners').once('value');
                const partners = snapshot.val();

                pendingDeliveryBoysTableBody.innerHTML = '';
                approvedDeliveryBoysTableBody.innerHTML = '';

                if (partners) {
                    let hasPending = false;
                    let hasApproved = false;

                    Object.keys(partners).forEach(id => {
                        const dp = partners[id];
                        const row = `
                            <tr>
                                <td>${dp.name}</td>
                                <td>${dp.email}</td>
                                <td>${dp.phone || 'N/A'}</td>
                                <td>${dp.vehicle || 'N/A'}</td>
                                <td><span class="status-badge status-${dp.approved ? 'approved' : 'pending'}">${dp.approved ? 'Approved' : 'Pending'}</span></td>
                                <td>
                                    ${!dp.approved ? `<button class="btn btn-success btn-sm" onclick="approveDeliveryPartner('${id}')">Approve</button>` : ''}
                                    ${dp.approved ? `<button class="btn btn-warning btn-sm" onclick="rejectDeliveryPartner('${id}')">Reject</button>` : ''}
                                    <button class="btn btn-danger btn-sm" onclick="deleteDeliveryPartner('${id}')">Delete</button>
                                </td>
                            </tr>
                        `;
                        if (!dp.approved) {
                            pendingDeliveryBoysTableBody.innerHTML += row;
                            hasPending = true;
                        } else {
                            approvedDeliveryBoysTableBody.innerHTML += row;
                            hasApproved = true;
                        }
                    });

                    if (!hasPending) {
                        pendingDeliveryBoysTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No pending delivery partners.</td></tr>';
                    }
                    if (!hasApproved) {
                        approvedDeliveryBoysTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No approved delivery partners.</td></tr>';
                    }
                } else {
                    pendingDeliveryBoysTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No delivery partners found.</td></tr>';
                    approvedDeliveryBoysTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No delivery partners found.</td></tr>';
                }
            } catch (error) {
                console.error("Error loading delivery partners:", error);
                pendingDeliveryBoysTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--danger-color);">Failed to load delivery partners.</td></tr>';
                approvedDeliveryBoysTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--danger-color);">Failed to load delivery partners.</td></tr>';
            }
        }

        async function approveDeliveryPartner(partnerId) {
            if (confirm("Are you sure you want to APPROVE this delivery partner?")) {
                try {
                    await database.ref(`deliveryPartners/${partnerId}`).update({ approved: true });
                    alert("Delivery partner approved successfully!");
                    loadPendingDeliveryPartners(); // Reload the list
                    loadDashboardStats(); // Update stats
                } catch (error) {
                    console.error("Error approving delivery partner:", error);
                    alert("Failed to approve delivery partner.");
                }
            }
        }

        async function rejectDeliveryPartner(partnerId) {
            if (confirm("Are you sure you want to REJECT this delivery partner? This will mark them as pending again.")) {
                try {
                    await database.ref(`deliveryPartners/${partnerId}`).update({ approved: false });
                    alert("Delivery partner rejected (marked as pending) successfully!");
                    loadPendingDeliveryPartners(); // Reload the list
                    loadDashboardStats(); // Update stats
                } catch (error) {
                    console.error("Error rejecting delivery partner:", error);
                    alert("Failed to reject delivery partner.");
                }
            }
        }

        async function deleteDeliveryPartner(partnerId) {
            if (confirm("Are you sure you want to DELETE this delivery partner? This action is irreversible.")) {
                try {
                    await database.ref(`deliveryPartners/${partnerId}`).remove();
                    alert("Delivery partner deleted successfully!");
                    loadPendingDeliveryPartners(); // Reload the list
                    loadDashboardStats(); // Update stats
                } catch (error) {
                    console.error("Error deleting delivery partner:", error);
                    alert("Failed to delete delivery partner.");
                }
            }
        }

        // --- Customers Management ---
        async function loadCustomers() {
            const customersTableBody = document.getElementById('customers-table-body');
            customersTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Loading customers...</td></tr>';

            try {
                const snapshot = await database.ref('customers').once('value');
                const customers = snapshot.val();

                customersTableBody.innerHTML = '';
                if (customers) {
                    Object.keys(customers).forEach(id => {
                        const c = customers[id];
                        customersTableBody.innerHTML += `
                            <tr>
                                <td>${c.name}</td>
                                <td>${c.email}</td>
                                <td>${c.phone || 'N/A'}</td>
                                <td>${c.address || 'N/A'}</td>
                                <td>
                                    <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${id}')">Delete</button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    customersTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No customers found.</td></tr>';
                }
            } catch (error) {
                console.error("Error loading customers:", error);
                customersTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--danger-color);">Failed to load customers.</td></tr>';
            }
        }

        async function deleteCustomer(customerId) {
            if (confirm("Are you sure you want to DELETE this customer? This action is irreversible.")) {
                try {
                    await database.ref(`customers/${customerId}`).remove();
                    // Consider removing their orders as well, or reassigning them
                    alert("Customer deleted successfully!");
                    loadCustomers(); // Reload the list
                    loadDashboardStats(); // Update stats
                } catch (error) {
                    console.error("Error deleting customer:", error);
                    alert("Failed to delete customer.");
                }
            }
        }

        // --- Orders Management ---
        let allOrders = {}; // To store orders for reassign/cancel functionality

        async function loadOrders() {
            const ordersTableBody = document.getElementById('orders-table-body');
            ordersTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Loading orders...</td></tr>';

            // Fetch delivery partners for reassign dropdown
            let deliveryPartners = {};
            const dpSnapshot = await database.ref('deliveryPartners').once('value');
            if (dpSnapshot.exists()) {
                dpSnapshot.forEach(childSnap => {
                    const dp = childSnap.val();
                    if (dp.approved) {
                        deliveryPartners[childSnap.key] = dp.name;
                    }
                });
            }

            try {
                const snapshot = await database.ref('orders').orderByChild('createdAt').once('value');
                const orders = snapshot.val();
                allOrders = orders || {}; // Store for later use

                ordersTableBody.innerHTML = '';
                if (orders) {
                    const orderKeys = Object.keys(orders).reverse(); // Show latest first
                    for (const orderId of orderKeys) {
                        const order = orders[orderId];
                        let customerName = 'N/A';
                        let restaurantName = 'N/A';
                        let deliveryPartnerName = 'N/A';

                        // Fetch customer, restaurant, and delivery partner names
                        const [customerSnap, restaurantSnap, dpSnap] = await Promise.all([
                            database.ref(`customers/${order.customerUid}`).once('value'),
                            database.ref(`restaurants/${order.restaurantId}`).once('value'),
                            order.deliveryUid ? database.ref(`deliveryPartners/${order.deliveryUid}`).once('value') : Promise.resolve(null)
                        ]);

                        if (customerSnap.exists()) customerName = customerSnap.val().name;
                        if (restaurantSnap.exists()) restaurantName = restaurantSnap.val().name;
                        if (dpSnap && dpSnap.exists()) deliveryPartnerName = dpSnap.val().name;

                        const itemsList = order.items.map(item => `${item.name} x ${item.quantity}`).join(', ');
                        const createdAt = new Date(order.createdAt).toLocaleString();

                        let reassignDropdown = `<select id="reassign-${orderId}" class="form-control" style="width: auto; display: inline-block; margin-right: 5px;">`;
